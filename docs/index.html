<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Irish Grid UMM Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .legend {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 999;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.35;
      min-width: 220px;
    }
    .legend-row { display: flex; align-items: center; gap: 10px; margin: 4px 0; }
    .dot {
      width: 12px; height: 12px; border-radius: 50%;
      display: inline-block;
    }
    .updated {
      margin-top: 8px;
      font-size: 12px;
      color: #444;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .err {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 999;
      background: rgba(255, 245, 245, 0.95);
      border: 1px solid rgba(255, 0, 0, 0.25);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 13px;
      max-width: 420px;
      display: none;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="legend" id="legend">
    <div class="legend-row"><span class="dot" style="background: green;"></span> Online</div>
    <div class="legend-row"><span class="dot" style="background: orange;"></span> Partial</div>
    <div class="legend-row"><span class="dot" style="background: red;"></span> Offline</div>
    <div class="updated" id="updated">Updated: —</div>
  </div>

  <div class="err" id="err"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const map = L.map("map").setView([53.3, -7.7], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 12,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function colorFor(p) {
      const a = Number(p.available_mw ?? 0);
      const u = Number(p.unavailable_mw ?? 0);

      // Your agreed logic:
      if (u === 0) return "green";
      if (a === 0) return "red";
      return "orange";
    }

    function fmt(n) {
      const x = Number(n);
      return Number.isFinite(x) ? x.toFixed(1).replace(/\.0$/, "") : "—";
    }

    async function load() {
      const errBox = document.getElementById("err");
      errBox.style.display = "none";
      errBox.textContent = "";

      // Cache-bust so updates show immediately
      const url = "status.geojson?ts=" + Date.now();

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load status.geojson (" + res.status + ")");

      const data = await res.json();

      // Update timestamp
      const updatedEl = document.getElementById("updated");
      updatedEl.textContent = "Updated: " + (data.generated_at_utc || "—") + " (UTC)";

      // Remove any existing layer then add fresh
      if (window._layer) {
        map.removeLayer(window._layer);
      }

      window._layer = L.geoJSON(data, {
        pointToLayer: function(feature, latlng) {
          const p = feature.properties || {};
          const c = colorFor(p);
          return L.circleMarker(latlng, {
            radius: 8,
            color: c,
            fillColor: c,
            fillOpacity: 0.85,
            weight: 2
          });
        },
        onEachFeature: function(feature, layer) {
          const p = feature.properties || {};
          const infra = p.infrastructure || "Unknown";
          const status = p.status || "unknown";
          const fuel = p.fuel || "";

          layer.bindPopup(`
            <b>${infra}</b><br/>
            Status: <b>${status}</b><br/>
            Available: <b>${fmt(p.available_mw)}</b> MW<br/>
            Unavailable: <b>${fmt(p.unavailable_mw)}</b> MW<br/>
            ${fuel ? `Fuel: ${fuel}<br/>` : ""}
          `);
        }
      }).addTo(map);
    }

    // Initial load
    load().catch(e => {
      const errBox = document.getElementById("err");
      errBox.style.display = "block";
      errBox.textContent = "Error loading data:\n" + (e && e.message ? e.message : String(e));
    });

    // Optional auto-refresh on the client every 60s (doesn't affect your polling)
    setInterval(() => {
      load().catch(() => {});
    }, 60 * 1000);
  </script>
</body>
</html>

